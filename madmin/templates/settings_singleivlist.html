{% extends "settings.html" %}

{% block header %}
{{ super() }}
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
$(document).ready(function () {
    $("#submit").click(function() {
        $.blockUI({ message: '<img src="{{ url_for('static', filename='loading.gif').lstrip('/') }}" width="100px" /><br /><h2>Saving {{ subtab }}...</h2>' });
        save_data = {
            'mon_ids_iv': [],
            'monlist': $("#monlist").val()
        };
        $.each($(".added-pokemon"), function() {
            mon_id = $(this).data('monid');
            if(!save_data['mon_ids_iv'].includes(mon_id)) {
                save_data['mon_ids_iv'].push(mon_id);
            }
        });
        $.ajax({
            url : "{{ uri }}",
            data : JSON.stringify(save_data),
            type : '{{ method }}',
            contentType : 'application/json',
            success: function(data, status, xhr) {
              if(xhr.status < 400)
                window.location.replace('{{ redirect }}');
            },
            error: function(data, status, xhr) {
                $("label[for]").removeClass('btn-danger');
                if(data['responseJSON'] != undefined) {
                    $.each(data['responseJSON']['missing'], function() {
                        var elem = $("label[for="+ this +"]");
                        elem[0].innerHTML = elem.attr('for') +' - Required Field';
                        elem.addClass('btn-danger');
                    });
                    $.each(data['responseJSON']['invalid'], function() {
                        var field = this.split(/:(.+)/)[0];
                        var expected = this.split(/:(.+)/)[1];
                        var elem = $("label[for="+ field +"]");
                        elem[0].innerHTML = elem.attr('for') +' - Expected '+ expected;
                        elem.addClass('btn-danger');
                    });
                    $.unblockUI();
                    alert('One or more fields failed validation');
                } else {
                    $.unblockUI();
                    alert('Unable to save the {{ subtab }}.  An unknown error occurred');
                }
            }
        });
    });
    $(".delete").click(function() {
        $(this).parent().remove();
    });
});
</script>
{% endblock %}

{% block content %}
{{ super() }}


<h1 class="display-4">{{ element.monlist }}</h1>

<div class="row">
  <div class="col-sm">
    <div class="form-group">
      <label for="monlist">monlist</label>
      <input type="input" class="form-control" id="monlist" name="monlist" value="{{ element.monlist }}">
      <small class="form-text text-muted">monlist</small>
    </div>
    <div class="form-group">
      <label for="mon_ids_iv">Selected Pokemon</label>
      {% for mon in current_mons_list %}
        <small class="form-text text-muted added-pokemon" data-monid='{{ mon.mon_id }}'><button data-identifier='{{ area_id }}' type="button" class="delete btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i></button>{{ mon.mon_name }}</small>
      {% endfor %}
    </div>
    <button type="button" id="submit" class="btn btn-success btn-lg btn-block">Save</button>
  </div>
</div>
{% endblock %}

