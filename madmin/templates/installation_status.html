{% extends "base.html" %}

{% block header %}
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.lazyload/1.9.1/jquery.lazyload.js"></script>
<script type="text/javascript" src="static/js/jquery.Aplus.min.js"></script>

<script>
    function setGrid(tableGridHtmlId, gridData) {
        $(tableGridHtmlId).DataTable({
            "data": gridData,
            "columns": [
                { data: 'origin', title: 'Device' },
                { data: 'file', title: 'File / Command' },
                { data: '', title: 'Jobtype' },
                { data: 'status', title: 'Status' },
                { data: '', title: 'Date/Time' },
                { data: '', title: 'Action' },
                { data: 'counter', title: 'Retry Counter' }
            ],
            "columnDefs": [
            {
                    "targets": [2],
                    "render": function (data, type, row) {

                        var jobtype = row.jobtype;

                        return jobtype.split(".")[1];
                    }
                },
                {
                    "targets": [5],
                    "render": function (data, type, row) {

                         var link = "<center><a href='delete_log_entry?id=" + row.id + "' class='confirm' title='Do you really want to delete this entry?'><img src='static/delete.png' width='30'></a> - <a href='restart_job?id=" + row.id + "&type=" + row.jobtype + "' class='confirm' title='Do you really want to restart this job?'><img src='static/restart.png' width='30'></a></center>";

                        return link;
                    }
                },
                {
                    "targets": [4],
                    "render": function (data, type, row) {

                         var date = new Date(row.id*1000);
                         var hours = date.getHours();
                         var minutes = "0" + date.getMinutes();
                         var seconds = "0" + date.getSeconds();
                         var year = date.getFullYear();
                         var month = "0" + (date.getMonth() + 1);
                         var day = "0" + date.getDate();

                         var link = year + '-' + month.substr(-2) + '-' +  day.substr(-2) + ' ' + hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);

                        return link;
                    }
                },
            ],
            "order": [[4, "desc"]],
            "responsive": {{ responsive }},
            "stateSave": true,
            "stateSaveCallback": function(settings,data) {
            localStorage.setItem( 'MAD_INSTALL_STATUS_' + settings.sInstance, JSON.stringify(data) )
            },
            "stateLoadCallback": function(settings) {
            return JSON.parse( localStorage.getItem( 'MAD_INSTALL_STATUS_' + settings.sInstance ) )
            }
        });
	}

    $(document).ready(function () {
        $('body').Aplus();
        $("#navgyms").addClass("active");
        $.ajax({
            type: "GET",
            url: "get_install_log",
            success: function (result) {
                setGrid('#show-data', result);
            }
        });
    });
</script>
{% endblock %}

{% block content %}
<h2>Jobstatus</h2>
<p>
	{% with messages = get_flashed_messages() %}
	  {% if messages %}
		{% for message in messages %}
		  <div class="p-3 mb-2 bg-secondary text-white">{{ message }}</div>
		{% endfor %}
	  {% endif %}
	{% endwith %}
</p>
<table id="show-data" class="table" style="width:100%;"></table>
<div class="alert alert-warning"><a href="/delete_log" class='confirm' title='Do you really want to delete the log?'>Delete Job Log</a></div>

{% endblock %}
