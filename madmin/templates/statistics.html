{% extends "base.html" %}

{% block header %}
{% endblock %}

{% block scripts %}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.selection.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.time.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.pie.min.js"></script>
<script>
$(function(){

        var options_dots = {
        xaxis: {
            mode: "time",
            timeformat: "%d.%m<br>%H:00 - ",
            minTickSize: [1, "hour"],
            timezone: "browser"
        },
        series: {
             lines: {
                 show: true,
                 color: '#ffa500'
             },
                 points: {
                 show: true
             }
        },
        grid: {
            hoverable: true,
            borderWidth: 1,
            backgroundColor: { colors: ["#ffffff", "#EDF5FF"] }
        },
        legend:{
            container:$("#legendContainer_spawn"),
            noColumns: 0
        }
        }

        var options_bars = {
        xaxis: {
            mode: "time",
            timeformat: "%d.%m<br>%H:00:00",
            minTickSize: [1, "hour"],
            timezone: "browser"
        },
        series: {
             bars: {
                 show: true
             }
        },
        bars: {
            align: "center",
            barWidth: 60 * 40 * 1000
        },
        grid: {
            hoverable: true,
            borderWidth: 2,
            backgroundColor: { colors: ["#ffffff", "#EDF5FF"] }
        },
        legend:{
            container:$("#legendContainer_quest"),
            noColumns: 0
        }
        }

        var options_pie = {
        series: {
        pie: {
            show: true,
            radius: 1,
            tilt: 0.5,
            label: {
                show:true,
                radius: 0.8,
                threshold: 0.1

            }
        }
        },
        legend:{
            show: true,
            labelFormatter: function (label, series) {
                    return '<div id="legendContainer" style="color:black;">' +
                    label + ' : ' +
                    (series.data[0][1]) +
                    '</div>';
                }
        }
        }

        $.blockUI({ message: '<img src="{{ url_for('static', filename='loading.gif') }}" width=100px /><br><h2>Load...</h2>' });

        // $('#ajax-loader').show();
        $.ajax({
            "url": "/get_game_stats",
            "type": "GET",
            "cache": false,
            "dataType": "json",
            success: function(result) {
            spawn = result.spawn
            quest = result.quest
            gym = result.gym
            stop = result.stop

            var plot_spawn = $.plot($("#flot_spawn"), [
                {
                    data: spawn.iv,
                    label: "IV Spawns / Hour"
                },
                {
                    data: spawn.noniv,
                    label: "NonIV Spawns / Hour"
                },
                {
                    data: spawn.sum,
                    label: "Sum Spawns / Hour"
                }
            ],  options_dots);
            $("#flot_spawn").UseTooltip();

            var plot_quest = $.plot($("#flot_quest"), [
                {
                    data: quest,
                    color: "#5482FF",
                    label: "Quest / Hour"
                }
            ],  options_bars);
            $("#flot_quest").UseTooltip();

            var plot_stop = $.plot($("#flot_stop"), stop,  options_pie);
            var plot_gym = $.plot($("#flot_gym"), gym,  options_pie);

            },
            complete: function(){
                setTimeout($.unblockUI, 500);
            }

        })

        var previousPoint = null, previousLabel = null;

        $.fn.UseTooltip = function () {
            $(this).bind("plothover", function (event, pos, item) {
                if (item) {
                    if ((previousLabel != item.series.label) || (previousPoint != item.dataIndex)) {
                        previousPoint = item.dataIndex;
                        previousLabel = item.series.label;
                        $("#tooltip").remove();

                        var x = item.datapoint[0];
                        var y = item.datapoint[1];
                        var color = item.series.color;
                        showTooltip(item.pageX,
                        item.pageY,
                        color,
                        "<strong>" + item.series.label + "</strong><br><strong>Amount:</strong> " + y + "<br><strong>Hour</strong>: "+ timeConverter(x) + "</strong>");
                    }
                } else {
                    $("#tooltip").remove();
                    previousPoint = null;
                }
            });
        };

        function timeConverter(timestamp){
          var a = new Date(timestamp);
          var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
          var year = a.getFullYear();
          var month = months[a.getMonth()];
          var date =  a.getDate();
          var hour = a.getHours();
          var hour_till = a.getHours() + 1;
          var min = a.getMinutes();
          var sec = a.getSeconds();
          var time = hour + ' - ' + hour_till
          return time;
        }

        function showTooltip(x, y, color, contents) {
            $('<div id="tooltip">' + contents + '</div>').css({
                position: 'absolute',
                display: 'none',
                top: y - 40,
                left: x - 120,
                border: '2px solid ' + color,
                padding: '3px',
                'font-size': '9px',
                'border-radius': '5px',
                'background-color': '#fff',
                'font-family': 'Verdana, Arial, Helvetica, Tahoma, sans-serif',
                opacity: 0.9
            }).appendTo("body").fadeIn(200);
        }
})

</script>

<style type="text/css">
    #flot_spawn{width:100%;height:300px;}
    #flot_quest{width:100%;height:300px;}
    #flot_gym{width:100%;height:300px;}
    #flot_stop{width:100%;height:300px;}

#legendContainer {
    background-color: #fff;
    padding: 2px;
    margin-bottom: 8px;
    display: inline-block;
    margin: 0 auto;
}

#flotcontainer {
    width: 600px;
    height: 200px;
    text-align: left;
}
</style>


{% endblock %}

{% block content %}
<h2>Spawn Statistics last day</h2>
<div id="legendContainer_spawn"></div>
<div id="flot_spawn"></div>
<br>
<h2>Today Quest Statistics</h2>
<div id="legendContainer_quest"></div>
<div id="flot_quest"></div>
<br>
<h2>Stop / Quest Statistics</h2>
<div id="flot_stop"></div>
<br>
<h2>Live Gym Statistics</h2>
<div id="flot_gym"></div>
<br><br>
{% endblock %}